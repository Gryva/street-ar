<!DOCTYPE html>
<html lang="hr">
  <head>
    <meta charset="UTF-8" />
    <title>Po≈°alji svoj rad</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Supabase JS (browser UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Shared auth helper (supabaseClient + ensureAnonAuth + ensureNickname) -->
    <script src="auth.js"></script>

    <!-- Cropper.js CSS & JS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

    <!-- Roboto Condensed s latin-ext -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;600;700&display=swap&subset=latin-ext"
    />

    <style>
      body {
        font-family: "Roboto Condensed", system-ui, sans-serif;
        padding: 20px 16px 90px;
        max-width: 600px;
        margin: 0 auto;
        background: #000;
        color: #fff;
      }

      h1 {
        margin-top: 8px;
        margin-bottom: 6px;
        font-size: 22px;
        letter-spacing: 0.04em;
      }

      .hidden {
        display: none !important;
      }

      .card {
        background: linear-gradient(
          145deg,
          #050505 0%,
          #111111 45%,
          #15181f 100%
        );
        border-radius: 16px;
        padding: 18px 16px 22px;
        border: 1px solid #222;
        box-shadow: 0 0 18px rgba(0, 0, 0, 0.75);
      }

      .section-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #bbbbbb;
        margin: 4px 0 12px;
      }

      label {
        display: block;
        margin-top: 16px;
        font-size: 12px;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: #aaaaaa;
      }

      .field-label-main {
        display: block;
        margin-bottom: 4px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 9px 11px;
        margin-top: 2px;
        box-sizing: border-box;
        border-radius: 999px;
        border: 1px solid #333;
        background: #111;
        color: #fff;
        font-family: "Roboto Condensed", system-ui, sans-serif;
        font-size: 13px;
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease,
          background 0.15s ease;
      }

      textarea {
        border-radius: 10px;
        resize: vertical;
        min-height: 80px;
        padding-top: 8px;
        padding-bottom: 8px;
        margin-top: 4px;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: #ffd700;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.35);
        background: #141414;
      }

      select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, #888 50%),
          linear-gradient(135deg, #888 50%, transparent 50%);
        background-position: calc(100% - 16px) 13px, calc(100% - 11px) 13px;
        background-size: 5px 5px, 5px 5px;
        background-repeat: no-repeat;
      }

      button {
        margin-top: 18px;
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: radial-gradient(
          circle at top left,
          rgba(255, 255, 255, 0.12),
          rgba(0, 0, 0, 0.96)
        );
        color: #fff;
        cursor: pointer;
        font-family: "Roboto Condensed", system-ui, sans-serif;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.65);
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          border-color 0.12s ease, background 0.12s ease;
      }

      button.primary {
        background: radial-gradient(
          circle at top left,
          rgba(255, 215, 0, 0.2),
          rgba(0, 0, 0, 0.96)
        );
        border-color: rgba(255, 215, 0, 0.6);
      }

      button.small {
        font-size: 12px;
        padding: 7px 11px;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      button:hover:not(:disabled) {
        box-shadow: 0 0 16px rgba(255, 215, 0, 0.4);
        border-color: rgba(255, 215, 0, 0.85);
        transform: translateY(-1px);
      }

      #status {
        margin-top: 18px;
        white-space: pre-line;
        font-size: 12px;
        opacity: 0.85;
      }

      #status::before {
        content: "‚óè ";
        color: #ffd700;
      }

      /* Slika + crop */
      #crop-container {
        margin-top: 16px;
        width: 100%;
        max-width: 100%;
        aspect-ratio: 4 / 3;
        position: relative;
        background: radial-gradient(circle at top, #202020, #050505 65%);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #333;
        display: none;
      }

      #crop-image {
        max-width: 100%;
        display: block;
      }

      #rotate-buttons {
        display: none;
        margin-top: 12px;
        display: flex;
        gap: 8px;
        justify-content: space-between;
      }

      #rotate-left {
        margin-right: auto;
      }

      #rotate-right {
        margin-left: auto;
      }

      #confirm-crop-btn {
        display: none;
        margin-top: 16px;
        width: 100%;
        text-align: center;
        justify-content: center;
      }

      #preview {
        margin-top: 16px;
        max-width: 100%;
        border: 1px solid #333;
        border-radius: 10px;
        display: none;
        box-shadow: 0 0 16px rgba(0, 0, 0, 0.7);
      }

      #loc-info {
        font-size: 11px;
        margin-top: 8px;
        opacity: 0.8;
        text-align: center;
      }

      #form-fields {
        display: none;
        margin-top: 22px;
      }

      #navbar-placeholder {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
      }

      .hint {
        font-size: 11px;
        opacity: 0.75;
        margin-top: 12px;
      }

      .pill-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: rgba(255, 215, 0, 0.1);
        border: 1px solid rgba(255, 215, 0, 0.5);
        color: #ffd700;
        font-size: 11px;
        margin-right: 6px;
      }

      #submit-btn {
        display: block;
        margin-left: auto;
        margin-right: auto;
        margin-top: 18px;
        min-width: 70%;
        text-align: center;
      }

      /* Ekran nakon slanja */
      #thankyou-screen {
        text-align: center;
        padding: 40px 10px 10px;
      }

      #thankyou-title {
        font-size: 24px;
        font-weight: 700;
        color: #ffd700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 10px;
      }

      #thankyou-subtitle {
        font-size: 14px;
        color: #ffffff;
        opacity: 0.9;
        margin-bottom: 22px;
      }

      #thankyou-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      #btn-go-scan,
      #btn-open-detail {
        width: 80%;
        max-width: 320px;
      }

      #btn-go-scan {
        border-color: rgba(255, 215, 0, 0.8);
      }

      #btn-open-detail {
        background: radial-gradient(
          circle at top left,
          rgba(255, 255, 255, 0.1),
          rgba(0, 0, 0, 0.96)
        );
      }

      /* Info o korisniƒçkom imenu */
      #user-info {
        font-size: 11px;
        opacity: 0.78;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <h1 id="page-title">Po≈°alji svoj rad u AR izlo≈æbu</h1>
    <p id="page-lead" class="lead">
      Na lokaciji si rada. Uslikaj, izre≈æi i dodaj osnovne informacije, a mi ƒáemo
      ga spojiti s AR iskustvom.
    </p>

    <div id="user-info"></div>

    <div class="card" id="main-card">
      <!-- 1. Slika + crop -->
      <div class="section-title" id="step1-title">Korak 1 ¬∑ Slika rada</div>
      <div id="submit-flow">
        <label id="image-label">
          <span class="field-label-main">
            <span class="pill-icon">üì∑</span>Slika rada (kamerom na lokaciji)
          </span>
          <input
            type="file"
            id="image"
            accept="image/*"
            capture="environment"
          />
        </label>

        <div id="crop-container">
          <img id="crop-image" alt="Za crop" />
        </div>

        <div id="rotate-buttons">
          <button type="button" id="rotate-left" class="small">
            ‚ü≤ Rotiraj lijevo
          </button>
          <button type="button" id="rotate-right" class="small">
            Rotiraj desno ‚ü≥
          </button>
        </div>

        <button
          type="button"
          id="confirm-crop-btn"
          class="small primary"
        >
          ‚úÖ Potvrdi crop i nastavi
        </button>

        <img id="preview" alt="Pregled izrezanog rada" />

        <!-- 2. Forma s podacima (pojavljuje se tek nakon cropa) -->
        <form id="submission-form">
          <div id="form-fields">
            <div class="section-title">Korak 2 ¬∑ Detalji rada</div>

            <label>
              <span class="field-label-main">Ime autora rada</span>
              <input type="text" id="artist_name" required />
            </label>

            <label>
              <span class="field-label-main">Ime rada</span>
              <input type="text" id="title" required />
            </label>

            <label>
              <span class="field-label-main">Tip rada</span>
              <select id="type" required>
                <option value="">Odaberi...</option>
                <option value="fotografija">Fotografija</option>
                <option value="crtez">Crte≈æ</option>
                <option value="grafit">Grafit</option>
                <option value="mural">Mural</option>
                <option value="plakat">Plakat</option>
                <option value="tag">Tag</option>
                <option value="sticker">Sticker</option>
                <option value="pasteup">Pasteup </option>
                <option value="ostalo">Ostalo</option>
              </select>
            </label>

            <label>
              <span class="field-label-main">Kratki opis (neobavezno)</span>
              <textarea
                id="description"
                rows="3"
                placeholder="Npr. kontekst rada, priƒça iza vizuala, zanimljivost..."
              ></textarea>
            </label>

            <!-- Lokacija ‚Äì info-only, bez gumba -->
            <label>
              <span class="field-label-main">Lokacija rada (GPS)</span>
              <div id="loc-info">Lokacija je preuzeta iz skeniranja (ako postoji).</div>
            </label>

            <button type="submit" id="submit-btn" class="primary">
              Po≈°alji rad u AR
            </button>

            <div class="hint">
              Rad ide prvo na odobrenje. Kad ga admin potvrdi, pojavit ƒáe se u AR
              skeniranju i na karti.
            </div>
          </div>
        </form>
      </div>

      <!-- Thank you screen (poƒçetno skriven) -->
      <div id="thankyou-screen" class="hidden">
        <div id="thankyou-title">Rad je poslan</div>
        <div id="thankyou-subtitle">Hvala na doprinosu!</div>
        <div id="thankyou-actions">
          <button id="btn-go-scan" class="primary">
            üîç Skeniraj vizuale
          </button>
          <button id="btn-open-detail">
            ‚ûú Provjeri status svog rada
          </button>
        </div>
      </div>

      <div id="status"></div>
    </div>

    <div id="navbar-placeholder"></div>

    <script>
      const form = document.getElementById("submission-form");
      const statusEl = document.getElementById("status");
      const locInfo = document.getElementById("loc-info");
      const imageInput = document.getElementById("image");
      const imageLabel = document.getElementById("image-label");
      const cropContainer = document.getElementById("crop-container");
      const cropImage = document.getElementById("crop-image");
      const confirmCropBtn = document.getElementById("confirm-crop-btn");
      const previewImg = document.getElementById("preview");
      const submitBtn = document.getElementById("submit-btn");
      const formFields = document.getElementById("form-fields");
      const rotateButtons = document.getElementById("rotate-buttons");
      const rotateLeftBtn = document.getElementById("rotate-left");
      const rotateRightBtn = document.getElementById("rotate-right");

      const pageTitle = document.getElementById("page-title");
      const pageLead = document.getElementById("page-lead");
      const step1Title = document.getElementById("step1-title");
      const submitFlow = document.getElementById("submit-flow");
      const thankyouScreen = document.getElementById("thankyou-screen");
      const btnGoScan = document.getElementById("btn-go-scan");
      const btnOpenDetail = document.getElementById("btn-open-detail");
      const userInfo = document.getElementById("user-info");

      let currentLat = null;
      let currentLon = null;
      let croppedFile = null;
      let imgFromScan = false;
      let cropper = null;
      let lastInsertedId = null;
      let draftId = null;

      function setStatus(msg) {
        statusEl.textContent = msg;
        console.log(msg);
      }

      // Poka≈æi pod kojim imenom user trenutno ≈°alje rad + osiguraj anon auth
      document.addEventListener("DOMContentLoaded", async () => {
        // auth user (anon ako treba)
        const user = await ensureAnonAuth();
        console.log("submit user:", user?.id);

        const nickname = await ensureNickname();
        if (nickname) {
          userInfo.textContent =
            "Trenutno ≈°alje≈° radove pod korisniƒçkim imenom: " + nickname;
        } else {
          userInfo.textContent =
            "Rad ƒáe biti poslan anonimno (bez korisniƒçkog imena).";
        }

        // ako dolazimo iz scana u edit-draft modu, uƒçitaj draft i GPS
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        const mode = params.get("mode");
        if (id && mode === "edit-draft") {
          draftId = id;
          await loadDraft(id);
        }

        // Navbar
        fetch("navbar.html")
          .then((res) => res.text())
          .then((html) => {
            document.getElementById("navbar-placeholder").innerHTML = html;
            const current = "submit";
            document
              .querySelectorAll("#navbar .nav-item")
              .forEach((item) => {
                if (item.dataset.tab === current)
                  item.classList.add("active");
              });
          });
      });

      async function loadDraft(id) {
        try {
          setStatus("Uƒçitavam draft rada...");
          const { data, error } = await supabaseClient
            .from("artwork_submissions")
            .select("*")
            .eq("id", id)
            .single();

          if (error || !data) {
            console.error(error);
            setStatus("Ne mogu uƒçitati draft rada.");
            return;
          }

                // postojeƒáa slika iz drafta -> prika≈æi je u cropperu
      if (data.image_path) {
        const { data: imgData } = supabaseClient.storage
          .from("submissions")
          .getPublicUrl(data.image_path);

        const imgUrl = imgData?.publicUrl;
        if (imgUrl) {
          imgFromScan = false;               // slika iz drafta
          imageLabel.style.display = "none"; // sakrij "Odaberi datoteku"
          showImageForCrop(imgUrl);          // otvori cropper s postojeƒáom slikom
        }
      }

      // GPS iz drafta  (ovo je tvoj postojeƒái kod)
      currentLat = data.latitude ?? null;
      currentLon = data.longitude ?? null;


          if (currentLat && currentLon) {
            locInfo.textContent =
              "Lokacija iz skeniranja ‚úî\n≈†irina: " +
              currentLat.toFixed(6) +
              "\nDuljina: " +
              currentLon.toFixed(6);
          } else {
            locInfo.textContent =
              "Lokacija iz skeniranja nije dostupna.";
          }

          // ako veƒá imamo podatke u draftu, mo≈æe≈° ih i prefillati
          if (data.artist_name) {
            document.getElementById("artist_name").value = data.artist_name;
          }
          if (data.title) {
            document.getElementById("title").value = data.title;
          }
          if (data.type) {
            document.getElementById("type").value = data.type;
          }
          if (data.description) {
            document.getElementById("description").value = data.description;
          }

          setStatus("");
        } catch (e) {
          console.error(e);
          setStatus("Gre≈°ka pri uƒçitavanju drafta.");
        }
      }

      // Cropper.js logika
      imageInput.addEventListener("change", () => {
        const file = imageInput.files[0];
        if (!file) {
          cropContainer.style.display = "none";
          confirmCropBtn.style.display = "none";
          rotateButtons.style.display = "none";
          previewImg.style.display = "none";
          formFields.style.display = "none";
          croppedFile = null;
          imgFromScan = false;
          if (cropper) {
            cropper.destroy();
            cropper = null;
          }
          return;
        }

        const url = URL.createObjectURL(file);
        imgFromScan = false;
        showImageForCrop(url);
      });

      function showImageForCrop(src) {
        cropImage.src = src;
        cropContainer.style.display = "block";
        confirmCropBtn.style.display = "block";
        rotateButtons.style.display = "flex";
        previewImg.style.display = "none";
        formFields.style.display = "none";
        croppedFile = null;
        setStatus(
          "Podesi kadar (zoom/rotacija) i potvrdi crop prije unosa podataka."
        );

        if (cropper) {
          cropper.destroy();
        }

        cropper = new Cropper(cropImage, {
          viewMode: 1,
          autoCropArea: 0.9,
          responsive: true,
          background: false,
          movable: true,
          zoomable: true,
          scalable: true,
          rotatable: true
        });
      }

      rotateLeftBtn.addEventListener("click", () => {
        if (cropper) cropper.rotate(-90);
      });

      rotateRightBtn.addEventListener("click", () => {
        if (cropper) cropper.rotate(90);
      });

      confirmCropBtn.addEventListener("click", () => {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({
          fillColor: "#000",
          imageSmoothingEnabled: true,
          imageSmoothingQuality: "high"
        });

        canvas.toBlob(
          (blob) => {
            if (!blob) return;

            let filename = "scan-crop.jpg";
            if (imageInput.files[0]) {
              filename = imageInput.files[0].name || "upload.jpg";
            }

            croppedFile = new File([blob], filename, {
              type: "image/jpeg"
            });

            if (imgFromScan) {
              localStorage.removeItem("street-ar-pending-image");
            }

            const previewUrl = URL.createObjectURL(blob);
            previewImg.src = previewUrl;
            previewImg.style.display = "block";
            formFields.style.display = "block";
            setStatus("");
          },
          "image/jpeg",
          0.9
        );
      });

      // provjeri je li skener ostavio sliku
      const pendingImageDataUrl = localStorage.getItem(
        "street-ar-pending-image"
      );
      if (pendingImageDataUrl) {
        imgFromScan = true;
        imageLabel.style.display = "none";
        showImageForCrop(pendingImageDataUrl);
      }

      // Upload slike u Storage (koristi CROPPANI file)
      async function uploadImage(file) {
        const ext = (file.name && file.name.split(".").pop()) || "jpg";
        const fileName = crypto.randomUUID() + "." + ext;
        const path = "submissions/" + fileName;

        const { data, error } = await supabaseClient.storage
          .from("submissions")
          .upload(path, file, {
            cacheControl: "3600",
            upsert: false
          });

        if (error) {
          throw error;
        }

        return data.path; // spremamo u image_path
      }

      function showThankYouScreen() {
        pageTitle.textContent = "Rad je poslan";
        if (pageLead) pageLead.classList.add("hidden");
        step1Title.classList.add("hidden");
        submitFlow.classList.add("hidden");
        thankyouScreen.classList.remove("hidden");
        setStatus("");
      }

      // Submit forme (INSERT ili UPDATE ovisno o draftId)
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setStatus("");

        if (!croppedFile) {
          setStatus("Prvo uslikaj rad i potvrdi crop.");
          return;
        }

        const artistName = document
          .getElementById("artist_name")
          .value.trim();
        const title = document.getElementById("title").value.trim();
        const type = document.getElementById("type").value;
        const description =
          document.getElementById("description").value.trim() || null;

        if (!artistName || !title || !type) {
          setStatus(
            "Molim te ispuni obavezna polja (autor, ime rada, tip)."
          );
          return;
        }

        const submittedBy = await ensureNickname(); // display nickname
        const user = await ensureAnonAuth();
        const ownerId = user?.id || null;

        setStatus("Uƒçitavam sliku, priƒçekaj...");
        submitBtn.disabled = true;

        try {
          const imagePath = await uploadImage(croppedFile);

          setStatus("Spremam podatke o radu...");

          let data, error;

          if (draftId) {
            // EDIT POSTOJEƒÜEG DRAFT RADA -> UPDATE u pending
            ({ data, error } = await supabaseClient
              .from("artwork_submissions")
              .update({
                artist_name: artistName,
                title,
                type,
                description,
                latitude: currentLat,
                longitude: currentLon,
                submitted_by: submittedBy,
                owner_id: ownerId,
                image_path: imagePath,
                status: "pending"
              })
              .eq("id", draftId)
              .select("id")
              .single());
          } else {
            // NOVI RAD -> INSERT kao pending
            ({ data, error } = await supabaseClient
              .from("artwork_submissions")
              .insert({
                artist_name: artistName,
                title,
                type,
                description,
                latitude: currentLat,
                longitude: currentLon,
                submitted_by: submittedBy,
                owner_id: ownerId,
                image_path: imagePath,
                status: "pending"
              })
              .select("id")
              .single());
          }

          if (error) {
            console.error(error);
            setStatus(
              "Dogodila se gre≈°ka pri spremanju rada: " + error.message
            );
            submitBtn.disabled = false;
            return;
          }

          lastInsertedId = data?.id || null;

          showThankYouScreen();
          submitBtn.disabled = false;
        } catch (err) {
          console.error(err);
          setStatus("Dogodila se gre≈°ka: " + err.message);
          submitBtn.disabled = false;
        }
      });

      // Thank-you gumbi
      btnGoScan.addEventListener("click", () => {
        window.location.href = "scan.html";
      });

      btnOpenDetail.addEventListener("click", () => {
        if (lastInsertedId) {
          window.location.href =
            "detail.html?id=" + encodeURIComponent(lastInsertedId);
        } else {
          window.location.href = "entries.html";
        }
      });
    </script>
  </body>
</html>
