<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MindAR Compiler UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- MindAR core (bez A-Frame) -->
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@0.4.2/dist/mindar.prod-min.js"></script>

    <!-- Supabase JS za browser (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      body { font-family: system-ui, sans-serif; padding: 16px; }
      #log {
        white-space: pre;
        background: #111;
        color: #0f0;
        padding: 8px;
        font-size: 12px;
        height: 200px;
        overflow: auto;
      }
      button { padding: 8px 16px; margin: 4px 0; }
    </style>
  </head>
  <body>
    <h1>MindAR compiler – Supabase</h1>
    <p>Otvori ovo samo ti (admin), ne korisnici.</p>

    <button id="compile-btn">Compile & Download targets.mind</button>
    <div id="log"></div>

    <script>
      const logEl = document.getElementById("log");
      function log(msg) {
        logEl.textContent += msg + "\n";
        logEl.scrollTop = logEl.scrollHeight;
        console.log(msg);
      }

      const SUPABASE_URL = "https://gppxvrknlnqzlzhcmstw.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_mnjwFbje0KmPYbUGnw-DRA_6V24GF0n"; // public anon key

      // UMD način: uzmemo createClient iz globalnog supabase objekta
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      async function fetchArtworksImages() {
        log("→ Čitam artworks iz Supabasea...");
        const { data, error } = await supabaseClient
          .from("artworks")
          .select("id, image_path")
          .order("created_at", { ascending: true });

        if (error) {
          log("Greška pri čitanju artworks: " + error.message);
          throw error;
        }

        log("Nađeno " + data.length + " radova.");
        return data;
      }

      async function getPublicImageUrl(path) {
        const { data } = supabaseClient.storage.from("artworks").getPublicUrl(path);
        return data.publicUrl;
      }

      async function loadImagesAsHTML(artworks) {
        const images = [];
        for (const art of artworks) {
          if (!art.image_path) continue;
          const url = await getPublicImageUrl(art.image_path);
          log("Učitavam sliku: " + url);

          const img = new Image();
          img.crossOrigin = "anonymous";
          img.src = url;

          await new Promise((resolve, reject) => {
            img.onload = () => resolve();
            img.onerror = (e) => reject(e);
          });

          images.push(img);
        }
        log("Sve slike učitane: " + images.length);
        return images;
      }

      async function compileAndDownload(images) {
        log("→ Pokrećem MindAR compiler...");
        const compiler = new window.MINDAR.Compiler();

        await compiler.compileImageTargets(images, (progress) => {
          log("Progress: " + Math.round(progress * 100) + "%");
        });

        log("Kompajliranje gotovo, exportam buffer...");
        const buffer = await compiler.exportData();

        const blob = new Blob([buffer], { type: "application/octet-stream" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "targets.mind";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        log("✔ targets.mind skinut.");
      }

      document
        .getElementById("compile-btn")
        .addEventListener("click", async () => {
          try {
            logEl.textContent = "";
            log("=== Start ===");
            const artworks = await fetchArtworksImages();
            const images = await loadImagesAsHTML(artworks);
            if (images.length === 0) {
              log("Nema slika za kompajlirati.");
              return;
            }
            await compileAndDownload(images);
            log("=== Gotovo ===");
          } catch (e) {
            console.error(e);
            log("Greška: " + e.message);
          }
        });
    </script>
  </body>
</html>
