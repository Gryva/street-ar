<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Street AR – Skeniraj</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Roboto Condensed s latin-ext (za HTML UI) -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;600;700&display=swap&subset=latin-ext"
  />

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
        sans-serif;
      background: #000;
      color: #fff;
    }
    a-scene {
      position: fixed;
      inset: 0;
    }

    /* Gornji status – centriran + mikro-animacija */
    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 12px;
      border-radius: 999px;
      z-index: 20;
      text-align: center;
      letter-spacing: 0.03em;
      animation: statusPulse 2s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }
    @keyframes statusPulse {
      0% {
        transform: translateX(-50%) translateY(0);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.12);
      }
      50% {
        transform: translateX(-50%) translateY(-1px);
        box-shadow: 0 0 16px rgba(255, 215, 0, 0.28);
      }
      100% {
        transform: translateX(-50%) translateY(0);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.12);
      }
    }

    #dimmer {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 15;
    }
    #dimmer.active {
      opacity: 1;
    }

    #navbar-placeholder {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
    }

    /* Donji panel kad nema markera */
    #no-marker-actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 60px;
      padding: 12px 16px 16px;
      background: linear-gradient(
        145deg,
        rgba(5, 5, 5, 0.96) 0%,
        rgba(10, 10, 18, 0.96) 45%,
        rgba(14, 16, 26, 0.96) 100%
      );
      color: #fff;
      font-size: 13px;
      z-index: 40;
      display: none;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }
    #no-marker-actions-text {
      opacity: 0.85;
      margin-bottom: 8px;
    }
    #no-marker-actions button {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: radial-gradient(
        circle at top left,
        rgba(255, 255, 255, 0.14),
        rgba(0, 0, 0, 0.95)
      );
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
        sans-serif;
      text-align: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease;
    }
    #no-marker-actions button:hover {
      box-shadow: 0 0 14px rgba(255, 215, 0, 0.35);
      border-color: rgba(255, 215, 0, 0.7);
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <!-- status -->
  <div id="status">Skeniraj vizuale za dodatan info.</div>
  <div id="dimmer"></div>

  <div id="no-marker-actions">
    <div id="no-marker-actions-text">
      Nismo uspjeli pronaći marker. Ako rad nije u bazi, možeš ga dodati i pričekati da ga admin odobri.
    </div>
    <button id="new-submit-btn">Slikaj rad za novi unos</button>
    <input
      type="file"
      id="scan-capture-input"
      accept="image/*"
      capture="environment"
      style="display:none;"
    />
  </div>

  <!-- AR SCENA -->
  <a-scene
    id="scene"
    mindar-image="imageTargetSrc: ./mind_files/targets.mind; filterMinCF:0.0001; filterBeta: 0.001;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-camera
      id="mainCamera"
      camera
      position="0 0 0"
      look-controls="enabled: false"
    ></a-camera>
  </a-scene>

  <div id="navbar-placeholder"></div>

  <script>
    // Component za auto-smanjivanje overlaya ovisno o udaljenosti kamere
    AFRAME.registerComponent("auto-resize-overlay", {
      schema: {
        minScale: { type: "number", default: 0.3 },
        maxScale: { type: "number", default: 1.0 },
        nearDistance: { type: "number", default: 0.15 },
        farDistance: { type: "number", default: 0.8 }
      },
      init: function () {
        const scene = this.el.sceneEl || AFRAME.scenes[0];
        this.cameraEl =
          scene && scene.camera && scene.camera.el
            ? scene.camera.el
            : document.querySelector("#mainCamera");
        this.vecCam = new THREE.Vector3();
        this.vecMe = new THREE.Vector3();
      },
      tick: function () {
        if (!this.cameraEl) return;
        const camPos = this.cameraEl.object3D.getWorldPosition(this.vecCam);
        const myPos = this.el.object3D.getWorldPosition(this.vecMe);
        const dist = camPos.distanceTo(myPos);

        const d = this.data;
        let t = (dist - d.nearDistance) / (d.farDistance - d.nearDistance);
        t = Math.max(0, Math.min(1, t));
        const scaleVal = d.minScale + (d.maxScale - d.minScale) * t;

        this.el.setAttribute("scale", `${scaleVal} ${scaleVal} ${scaleVal}`);
      }
    });

    const statusEl = document.getElementById("status");
    const dimmer = document.getElementById("dimmer");
    const scene = document.getElementById("scene");
    const noMarkerActions = document.getElementById("no-marker-actions");
    const noMarkerText = document.getElementById("no-marker-actions-text");
    const newSubmitBtn = document.getElementById("new-submit-btn");
    const captureInput = document.getElementById("scan-capture-input");

    // Supabase client
    const SUPABASE_URL = "https://gppxvrknlnqzlzhcmstw.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY =
      "sb_publishable_mnjwFbje0KmPYbUGnw-DRA_6V24GF0n";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

    const markers = [];
    let anyVisible = false;
    let fallbackTimer = null;

    function updateDimmer() {
      if (anyVisible) dimmer.classList.add("active");
      else dimmer.classList.remove("active");
    }

    function showNoMarkerActions() {
      if (noMarkerActions && !anyVisible) {
        noMarkerActions.style.display = "block";
      }
    }

    function scheduleFallback() {
      if (fallbackTimer) clearTimeout(fallbackTimer);
      if (!anyVisible) {
        fallbackTimer = setTimeout(showNoMarkerActions, 5000);
      }
    }

    function attachMarkerEvents() {
      markers.forEach((marker, index) => {
        marker.addEventListener("targetFound", () => {
          anyVisible = true;
          if (fallbackTimer) {
            clearTimeout(fallbackTimer);
            fallbackTimer = null;
          }
          if (noMarkerActions) noMarkerActions.style.display = "none";
          statusEl.textContent = `Prepoznat rad`;
          updateDimmer();
        });

        marker.addEventListener("targetLost", () => {
          anyVisible = markers.some(
            (m) => m.components["mindar-image-target"]?.__targetVisible
          );
          if (!anyVisible) {
            statusEl.textContent = "Skeniraj vizuale za dodatan info.";
            scheduleFallback();
          }
          updateDimmer();
        });
      });
    }

    // Dinamičko generiranje markera iz Supabasea
    async function loadMarkersFromSupabase() {
      statusEl.textContent = "Učitavam AR radove...";

      const { data, error } = await supabaseClient
        .from("artwork_submissions")
        .select("*")
        .eq("status", "approved")
        .not("target_index", "is", null)
        .order("target_index", { ascending: true });

      if (error) {
        console.error(error);
        statusEl.textContent =
          "Greška pri učitavanju radova za AR: " + error.message;
        return;
      }

      if (!data || !data.length) {
        statusEl.textContent =
          "Još nema odobrenih radova za AR. Prijavi svoj rad!";
        scheduleFallback();
        return;
      }

      statusEl.textContent = "Skeniraj vizuale za dodatan info.";

      data.forEach((item) => {
        const marker = document.createElement("a-entity");
        marker.setAttribute(
          "mindar-image-target",
          `targetIndex: ${item.target_index}`
        );
        marker.setAttribute("auto-resize-overlay", "");

        // okvir (pomaknut gore ~15%)
        const frame = document.createElement("a-entity");
        frame.setAttribute("position", "0 0.15 0");
        frame.innerHTML = `
          <a-plane width="1.0" height="0.04" color="#ffffff" opacity="0.9" position="0 0.45 0"></a-plane>
          <a-plane width="1.0" height="0.04" color="#ffffff" opacity="0.9" position="0 -0.45 0"></a-plane>
          <a-plane width="0.04" height="0.8" color="#ffffff" opacity="0.9" position="-0.5 0 0"></a-plane>
          <a-plane width="0.04" height="0.8" color="#ffffff" opacity="0.9" position="0.5 0 0"></a-plane>
        `;
        marker.appendChild(frame);

        const title = item.title || "(bez naslova)";
        const artist = item.artist_name || "Nepoznat autor";
        const type = item.type || "rad";
        const desc = item.description || "";

        const textBlock = document.createElement("a-entity");
        textBlock.setAttribute("position", "0 0.15 0");

        textBlock.innerHTML = `
          <!-- GORNJI OVERLAY (naslov + autor/tip) -->
          <a-entity position="0 0.9 0">
            <!-- Card background s blagim glowom -->
            <a-plane width="1.8" height="0.42" color="#000000" opacity="0.88"
                     material="shader: flat; src: #cardGradient"></a-plane>
            <a-plane width="1.86" height="0.46" color="#ffd700" opacity="0.12"></a-plane>

            <!-- Naslov -->
            <a-text value="${title}"
                    color="#ffd700"
                    align="center"
                    width="2.2"
                    position="0 0.11 0.02"
                    wrap-count="32"></a-text>

            <!-- Autor + tip -->
            <a-text value="Autor: ${artist} • Tip: ${type}"
                    color="#ffffff"
                    align="center"
                    width="2.2"
                    position="0 -0.07 0.02"
                    wrap-count="38"></a-text>
          </a-entity>

          <!-- DONJI OVERLAY (opis, ako postoji) -->
          ${
            desc
              ? `
          <a-entity position="0 -1.0 0">
            <a-plane width="1.9" height="0.7" color="#000000" opacity="0.88"></a-plane>
            <a-text value="${desc}"
                    color="#dddddd"
                    align="center"
                    width="2.3"
                    position="0 0 0.02"
                    wrap-count="44"></a-text>
          </a-entity>
              `
              : ""
          }
        `;
        marker.appendChild(textBlock);

        scene.appendChild(marker);
        markers.push(marker);
      });

      attachMarkerEvents();
      scheduleFallback();
    }

    // startni timer (ako se markeri ne učitaju ili nema ničega)
    scheduleFallback();
    loadMarkersFromSupabase();

    // Gumb "Slikaj rad za novi unos"
    newSubmitBtn.addEventListener("click", () => {
      captureInput.value = "";
      captureInput.click();
    });

    captureInput.addEventListener("change", () => {
      const file = captureInput.files && captureInput.files[0];
      if (!file) {
        statusEl.textContent = "Slikanje je otkazano. Pokušaj ponovno.";
        return;
      }

      statusEl.textContent = "Obrađujem sliku...";
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        if (!dataUrl) {
          statusEl.textContent = "Dogodila se greška pri čitanju slike.";
          return;
        }
        try {
          localStorage.setItem("street-ar-pending-image", dataUrl);
        } catch (e) {
          console.error(e);
          statusEl.textContent = "Ne mogu spremiti sliku (localStorage).";
          return;
        }
        setTimeout(() => {
          window.location.href = "submit.html";
        }, 100);
      };
      reader.onerror = () => {
        statusEl.textContent = "Dogodila se greška pri čitanju slike.";
      };
      reader.readAsDataURL(file);
    });

    // Navbar
    fetch("navbar.html")
      .then((res) => res.text())
      .then((html) => {
        document.getElementById("navbar-placeholder").innerHTML = html;
        const current = "scan";
        document
          .querySelectorAll("#navbar .nav-item")
          .forEach((item) => {
            if (item.dataset.tab === current) item.classList.add("active");
          });
      });
  </script>
</body>
</html>
