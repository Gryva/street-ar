<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Street AR – Skeniraj</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    a-scene { position: fixed; inset: 0; }

    #status {
      position: absolute;
      top: 8px; left: 10px;
      padding: 4px 8px;
      background: rgba(0,0,0,0.5);
      color: #fff;
      font-size: 11px;
      border-radius: 4px;
      z-index: 20;
    }

    #dimmer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 15;
    }
    #dimmer.active { opacity: 1; }

    #navbar-placeholder {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 50;
    }

    #no-marker-actions {
      position: fixed;
      left: 0; right: 0;
      bottom: 60px;
      padding: 10px 16px;
      background: rgba(0,0,0,0.85);
      color: #fff;
      font-size: 13px;
      z-index: 40;
      display: none;
    }
    #no-marker-actions button {
      width: 100%;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #1a1a1a;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
    #no-marker-actions button.secondary {
      background: transparent;
    }
  </style>
</head>
<body>
  <div id="status">Nismo uspjeli pronaći marker.</div>
  <div id="dimmer"></div>

  <div id="no-marker-actions">
    <div>Nismo uspjeli pronaći marker.</div>
    <button id="retry-btn" class="secondary">Pokušaj ponovno skenirati</button>
    <button id="new-submit-btn">Slikaj rad za novi unos</button>
    <input
      type="file"
      id="scan-capture-input"
      accept="image/*"
      capture="environment"
      style="display:none;"
    />
  </div>

  <!-- AR SCENA -->
  <a-scene
    id="scene"
    mindar-image="imageTargetSrc: ./mind_files/targets.mind; filterMinCF:0.0001; filterBeta: 0.001;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
  </a-scene>

  <div id="navbar-placeholder"></div>

  <script>
    const statusEl = document.getElementById("status");
    const dimmer = document.getElementById("dimmer");
    const scene = document.getElementById("scene");
    const noMarkerActions = document.getElementById("no-marker-actions");
    const retryBtn = document.getElementById("retry-btn");
    const newSubmitBtn = document.getElementById("new-submit-btn");
    const captureInput = document.getElementById("scan-capture-input");

    // Supabase client
    const SUPABASE_URL = "https://gppxvrknlnqzlzhcmstw.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY =
      "sb_publishable_mnjwFbje0KmPYbUGnw-DRA_6V24GF0n";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY);

    const markers = [];
    let anyVisible = false;
    let fallbackTimer = null;

    function updateDimmer() {
      if (anyVisible) dimmer.classList.add("active");
      else dimmer.classList.remove("active");
    }

    function showNoMarkerActions() {
      if (noMarkerActions && !anyVisible) {
        noMarkerActions.style.display = "block";
        statusEl.textContent = "Nismo uspjeli pronaći marker.";
      }
    }

    function scheduleFallback() {
      if (fallbackTimer) clearTimeout(fallbackTimer);
      if (!anyVisible) {
        fallbackTimer = setTimeout(showNoMarkerActions, 5000);
      }
    }

    function attachMarkerEvents() {
      markers.forEach((marker, index) => {
        marker.addEventListener("targetFound", () => {
          anyVisible = true;
          if (fallbackTimer) {
            clearTimeout(fallbackTimer);
            fallbackTimer = null;
          }
          if (noMarkerActions) noMarkerActions.style.display = "none";
          statusEl.textContent = `Prepoznat rad #${index + 1}`;
          updateDimmer();
        });

        marker.addEventListener("targetLost", () => {
          anyVisible = markers.some(
            (m) => m.components["mindar-image-target"]?.__targetVisible
          );
          if (!anyVisible) {
            statusEl.textContent = "Nismo uspjeli pronaći marker.";
            scheduleFallback();
          }
          updateDimmer();
        });
      });
    }

    // Dinamičko generiranje markera iz Supabasea
    async function loadMarkersFromSupabase() {
      statusEl.textContent = "Učitavam AR radove...";

      const { data, error } = await supabaseClient
  .from("artwork_submissions")
  .select("*")
  .eq("status", "approved")
  .not("target_index", "is", null)
  .order("target_index", { ascending: true });


      if (error) {
        console.error(error);
        statusEl.textContent =
          "Greška pri učitavanju radova za AR: " + error.message;
        return;
      }

      if (!data || !data.length) {
        statusEl.textContent =
          "Još nema odobrenih radova za AR. Prijavi svoj rad!";
        scheduleFallback();
        return;
      }

      statusEl.textContent = "Skeniraj odobrene radove za AR.";

      data.forEach((item, index) => {
  const marker = document.createElement("a-entity");
  marker.setAttribute(
    "mindar-image-target",
    `targetIndex: ${item.target_index}`
  );



        const frame = document.createElement("a-entity");
        frame.setAttribute("position", "0 0 0");
        frame.innerHTML = `
          <a-plane width="1.2" height="0.06" color="#ffffff" opacity="0.9" position="0 0.5 0"></a-plane>
          <a-plane width="1.2" height="0.06" color="#ffffff" opacity="0.9" position="0 -0.5 0"></a-plane>
          <a-plane width="0.06" height="0.9" color="#ffffff" opacity="0.9" position="-0.6 0 0"></a-plane>
          <a-plane width="0.06" height="0.9" color="#ffffff" opacity="0.9" position="0.6 0 0"></a-plane>
        `;
        marker.appendChild(frame);

        const title = item.title || "(bez naslova)";
        const artist = item.artist_name || "Nepoznat autor";
        const type = item.type || "rad";
        const desc = item.description || "";

        const textBlock = document.createElement("a-entity");
        textBlock.setAttribute("position", "0 -1.1 0");
        textBlock.innerHTML = `
          <a-plane width="1.8" height="0.6" color="#000000" opacity="0.9"></a-plane>
          <a-text value="${title}"
                  color="#ffffff" align="center" width="3.2"
                  position="0 0.24 0.01"></a-text>
          <a-text value="Autor: ${artist} • Tip: ${type}"
                  color="#cccccc" align="center" width="3.2"
                  position="0 0.08 0.01" wrap-count="36"></a-text>
          ${
            desc
              ? `<a-text value="${desc}"
                         color="#aaaaaa" align="center" width="3.2"
                         position="0 -0.14 0.01" wrap-count="40"></a-text>`
              : ""
          }
        `;
        marker.appendChild(textBlock);

        scene.appendChild(marker);
        markers.push(marker);
      });

      attachMarkerEvents();
      scheduleFallback();
    }

    // startni timer (ako se markeri ne učitaju ili nema ničega)
    scheduleFallback();
    loadMarkersFromSupabase();

    // Gumb "Pokušaj ponovno"
    retryBtn.addEventListener("click", () => {
      if (noMarkerActions) noMarkerActions.style.display = "none";
      statusEl.textContent = "Nismo uspjeli pronaći marker.";
      anyVisible = false;
      scheduleFallback();
    });

    // Gumb "Slikaj rad za novi unos"
    newSubmitBtn.addEventListener("click", () => {
      captureInput.value = "";
      captureInput.click();
    });

    captureInput.addEventListener("change", () => {
      const file = captureInput.files && captureInput.files[0];
      if (!file) {
        statusEl.textContent = "Slikanje je otkazano. Pokušaj ponovno.";
        return;
      }

      statusEl.textContent = "Obrađujem sliku...";
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        if (!dataUrl) {
          statusEl.textContent = "Dogodila se greška pri čitanju slike.";
          return;
        }
        try {
          localStorage.setItem("street-ar-pending-image", dataUrl);
        } catch (e) {
          console.error(e);
          statusEl.textContent = "Ne mogu spremiti sliku (localStorage).";
          return;
        }
        setTimeout(() => {
          window.location.href = "submit.html";
        }, 100);
      };
      reader.onerror = () => {
        statusEl.textContent = "Dogodila se greška pri čitanju slike.";
      };
      reader.readAsDataURL(file);
    });

    // Navbar
    fetch("navbar.html")
      .then((res) => res.text())
      .then((html) => {
        document.getElementById("navbar-placeholder").innerHTML = html;
        const current = "scan";
        document
          .querySelectorAll("#navbar .nav-item")
          .forEach((item) => {
            if (item.dataset.tab === current) item.classList.add("active");
          });
      });
  </script>
</body>
</html>
