<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Street AR ‚Äì Skeniraj</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mindar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared auth helper (supabaseClient + ensureAnonAuth + ensureNickname) -->
  <script src="auth.js"></script>

  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;600;700&display=swap&subset=latin-ext"
  />

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
        sans-serif;
      background: #000;
      color: #fff;
    }
    a-scene {
      position: fixed;
      inset: 0;
    }

    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 12px;
      border-radius: 999px;
      z-index: 20;
      text-align: center;
      letter-spacing: 0.03em;
      animation: statusPulse 2s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
      max-width: 90%;
    }
    @keyframes statusPulse {
      0% {
        transform: translateX(-50%) translateY(0);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.12);
      }
      50% {
        transform: translateX(-50%) translateY(-1px);
        box-shadow: 0 0 16px rgba(255, 215, 0, 0.28);
      }
      100% {
        transform: translateX(-50%) translateY(0);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.12);
      }
    }

    #dimmer {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 15;
    }
    #dimmer.active {
      opacity: 1;
    }

    #navbar-placeholder {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
    }

    #no-marker-actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 60px;
      padding: 12px 16px 16px;
      background: linear-gradient(
        145deg,
        rgba(5, 5, 5, 0.96) 0%,
        rgba(10, 10, 18, 0.96) 45%,
        rgba(14, 16, 26, 0.96) 100%
      );
      color: #fff;
      font-size: 13px;
      z-index: 40;
      display: none;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }
    #no-marker-actions-text {
      opacity: 0.85;
      margin-bottom: 8px;
    }
    #no-marker-actions button {
      width: 100%;
      margin-top: 6px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: radial-gradient(
        circle at top left,
        rgba(255, 255, 255, 0.14),
        rgba(0, 0, 0, 0.95)
      );
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
        sans-serif;
      text-align: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    #no-marker-actions button::after {
      content: "üì∑";
      font-size: 17px;
      line-height: 1;
    }
    #no-marker-actions button:hover {
      box-shadow: 0 0 14px rgba(255, 215, 0, 0.35);
      border-color: rgba(255, 215, 0, 0.7);
      transform: translateY(-1px);
    }

    #post-capture-actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 60px;
      padding: 12px 16px 16px;
      background: linear-gradient(
        145deg,
        rgba(5, 5, 5, 0.96) 0%,
        rgba(10, 10, 18, 0.96) 45%,
        rgba(14, 16, 26, 0.96) 100%
      );
      color: #fff;
      font-size: 13px;
      z-index: 45;
      display: none;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.8);
      border-top: 1px solid rgba(255, 255, 255, 0.12);
    }
    #post-capture-text {
      opacity: 0.85;
      margin-bottom: 8px;
    }
    #post-capture-actions button {
      width: 100%;
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: radial-gradient(
        circle at top left,
        rgba(255, 255, 255, 0.14),
        rgba(0, 0, 0, 0.95)
      );
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
        sans-serif;
      text-align: center;
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        border-color 0.12s ease;
    }
    #post-capture-actions button:hover {
      box-shadow: 0 0 14px rgba(255, 215, 0, 0.35);
      border-color: rgba(255, 215, 0, 0.7);
      transform: translateY(-1px);
    }

    /* Panel za otvaranje detalja prepoznatog rada */
    #ar-detail-actions {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 120px;
      padding: 8px 16px;
      z-index: 46;
      display: none;
      pointer-events: auto;
    }
    #btn-open-detail {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: radial-gradient(
        circle at top left,
        rgba(255, 255, 255, 0.16),
        rgba(0, 0, 0, 0.96)
      );
      color: #ffffff;
      font-size: 12px;
      cursor: pointer;
      font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
        sans-serif;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Override MindAR scanning overlay pozicije */
    .mindar-ui-overlay.mindar-ui-scanning {
      top: 20% !important;
      bottom: auto !important;
    }
    .mindar-ui-overlay.mindar-ui-scanning .scanning {
      transform: translateY(-20px);
    }
  </style>
</head>
<body>
  <div id="status">Skeniraj vizuale za dodatan info.</div>
  <div id="dimmer"></div>

  <div id="no-marker-actions">
    <div id="no-marker-actions-text">
      Nismo uspjeli pronaƒái marker. Ako rad nije u bazi, mo≈æe≈° ga dodati i priƒçekati da ga admin odobri.
    </div>
    <button id="new-submit-btn">Slikaj rad za novi unos</button>
    <input
      type="file"
      id="scan-capture-input"
      accept="image/*"
      capture="environment"
      style="display:none;"
    />
  </div>

  <div id="post-capture-actions">
    <div id="post-capture-text">
      Slika i lokacija su spremljeni kao draft. Mo≈æe≈° odmah unijeti informacije ili dovr≈°iti kasnije.
    </div>
    <button id="btn-edit-now">Nastavi na unos informacija</button>
    <button id="btn-save-draft-only">Spremi samo kao draft</button>
  </div>

  <!-- gumb za detalje prepoznatog rada -->
  <div id="ar-detail-actions">
    <button id="btn-open-detail">Otvori detalje rada</button>
  </div>

  <a-scene
    id="scene"
    mindar-image="imageTargetSrc: ./mind_files/targets.mind; filterMinCF:0.0001; filterBeta: 0.001;"
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-camera
      id="mainCamera"
      camera
      position="0 0 0"
      look-controls="enabled: false"
    ></a-camera>
  </a-scene>

  <div id="navbar-placeholder"></div>

  <script>
    AFRAME.registerComponent("auto-resize-overlay", {
      schema: {
        minScale: { type: "number", default: 0.3 },
        maxScale: { type: "number", default: 1.0 },
        nearDistance: { type: "number", default: 0.15 },
        farDistance: { type: "number", default: 0.8 }
      },
      init: function () {
        const scene = this.el.sceneEl || AFRAME.scenes[0];
        this.cameraEl =
          scene && scene.camera && scene.camera.el
            ? scene.camera.el
            : document.querySelector("#mainCamera");
        this.vecCam = new THREE.Vector3();
        this.vecMe = new THREE.Vector3();
      },
      tick: function () {
        if (!this.cameraEl) return;
        const camPos = this.cameraEl.object3D.getWorldPosition(this.vecCam);
        const myPos = this.el.object3D.getWorldPosition(this.vecMe);
        const dist = camPos.distanceTo(myPos);

        const d = this.data;
        let t = (dist - d.nearDistance) / (d.farDistance - d.nearDistance);
        t = Math.max(0, Math.min(1, t));
        const scaleVal = d.minScale + (d.maxScale - d.minScale) * t;

        this.el.setAttribute("scale", `${scaleVal} ${scaleVal} ${scaleVal}`);
      }
    });

    const statusEl = document.getElementById("status");
    const dimmer = document.getElementById("dimmer");
    const scene = document.getElementById("scene");
    const noMarkerActions = document.getElementById("no-marker-actions");
    const newSubmitBtn = document.getElementById("new-submit-btn");
    const captureInput = document.getElementById("scan-capture-input");
    const postCapturePanel = document.getElementById("post-capture-actions");
    const btnEditNow = document.getElementById("btn-edit-now");
    const btnSaveDraftOnly = document.getElementById("btn-save-draft-only");
    const arDetailPanel = document.getElementById("ar-detail-actions");
    const btnOpenDetail = document.getElementById("btn-open-detail");

    const markers = [];
    let anyVisible = false;
    let fallbackTimer = null;
    let lastDraftId = null;
    let currentArtworkId = null;

    function updateDimmer() {
      if (anyVisible) dimmer.classList.add("active");
      else dimmer.classList.remove("active");
    }

    function showNoMarkerActions() {
      if (noMarkerActions && !anyVisible) {
        noMarkerActions.style.display = "block";
      }
    }

    function scheduleFallback() {
      if (fallbackTimer) clearTimeout(fallbackTimer);
      if (!anyVisible) {
        fallbackTimer = setTimeout(showNoMarkerActions, 3000);
      }
    }

    function attachMarkerEvents() {
      markers.forEach((marker) => {
        marker.addEventListener("targetFound", () => {
          anyVisible = true;
          if (fallbackTimer) {
            clearTimeout(fallbackTimer);
            fallbackTimer = null;
          }
          if (noMarkerActions) noMarkerActions.style.display = "none";
          statusEl.textContent = "Prepoznat rad";

          currentArtworkId = marker.dataset.artworkId || null;
          if (currentArtworkId) {
            arDetailPanel.style.display = "block";
          }

          updateDimmer();
        });

        marker.addEventListener("targetLost", () => {
          anyVisible = markers.some(
            (m) => m.components["mindar-image-target"]?.__targetVisible
          );
          if (!anyVisible) {
            statusEl.textContent = "Skeniraj vizuale za dodatan info.";
            scheduleFallback();
            currentArtworkId = null;
            arDetailPanel.style.display = "none";
          }
          updateDimmer();
        });
      });
    }

    async function loadMarkersFromSupabase() {
      statusEl.textContent = "Uƒçitavam AR radove...";

      const { data, error } = await supabaseClient
        .from("artwork_submissions")
        .select("*")
        .eq("status", "approved")
        .not("target_index", "is", null)
        .order("target_index", { ascending: true });

      if (error) {
        console.error(error);
        statusEl.textContent =
          "Gre≈°ka pri uƒçitavanju radova za AR: " + error.message;
        return;
      }

      if (!data || !data.length) {
        statusEl.textContent =
          "Jo≈° nema odobrenih radova za AR. Prijavi svoj rad!";
        scheduleFallback();
        return;
      }

      statusEl.textContent = "Skeniraj vizuale za dodatan info.";

      data.forEach((item) => {
        const marker = document.createElement("a-entity");
        marker.setAttribute(
          "mindar-image-target",
          `targetIndex: ${item.target_index}`
        );
        marker.setAttribute("auto-resize-overlay", "");

        // spremi ID rada za kasnije
        marker.dataset.artworkId = item.id;

        // okvir
        const frame = document.createElement("a-entity");
        frame.setAttribute("position", "0 0.15 0");
        frame.innerHTML = `
          <a-plane width="1.0" height="0.04" color="#ffffff" opacity="0.9" position="0 0.45 0"></a-plane>
          <a-plane width="1.0" height="0.04" color="#ffffff" opacity="0.9" position="0 -0.45 0"></a-plane>
          <a-plane width="0.04" height="0.8" color="#ffffff" opacity="0.9" position="-0.5 0 0"></a-plane>
          <a-plane width="0.04" height="0.8" color="#ffffff" opacity="0.9" position="0.5 0 0"></a-plane>
        `;
        marker.appendChild(frame);

        const title = item.title || "(bez naslova)";
        const artist = item.artist_name || "Nepoznat autor";
        const type = item.type || "rad";
        const desc = item.description || "";

        const textBlock = document.createElement("a-entity");
        textBlock.setAttribute("position", "0 0.15 0");

        // gornji panel (naslov + meta)
        const topPanel = document.createElement("a-entity");
        topPanel.setAttribute("position", "0 0.9 0");

        const topBg = document.createElement("a-plane");
        topBg.setAttribute("width", "1.8");
        topBg.setAttribute("height", "0.42");
        topBg.setAttribute("color", "#000000");
        topBg.setAttribute("opacity", "0.88");
        topPanel.appendChild(topBg);

        const topBorder = document.createElement("a-plane");
        topBorder.setAttribute("width", "1.86");
        topBorder.setAttribute("height", "0.46");
        topBorder.setAttribute("color", "#ffd700");
        topBorder.setAttribute("opacity", "0.12");
        topPanel.appendChild(topBorder);

        const titleText = document.createElement("a-text");
        titleText.setAttribute("color", "#ffd700");
        titleText.setAttribute("align", "center");
        titleText.setAttribute("width", "2.2");
        titleText.setAttribute("position", "0 0.11 0.02");
        titleText.setAttribute("wrap-count", "32");
        titleText.setAttribute("value", title);
        topPanel.appendChild(titleText);

        const metaText = document.createElement("a-text");
        metaText.setAttribute("color", "#ffffff");
        metaText.setAttribute("align", "center");
        metaText.setAttribute("width", "2.2");
        metaText.setAttribute("position", "0 -0.07 0.02");
        metaText.setAttribute("wrap-count", "38");
        metaText.setAttribute(
          "value",
          `Autor: ${artist} ‚Ä¢ Tip: ${type}`
        );
        topPanel.appendChild(metaText);

        textBlock.appendChild(topPanel);

        // opis (ako postoji)
        if (desc) {
          const bottomPanel = document.createElement("a-entity");
          bottomPanel.setAttribute("position", "0 -1.0 0");

          const bottomBg = document.createElement("a-plane");
          bottomBg.setAttribute("width", "1.9");
          bottomBg.setAttribute("height", "0.7");
          bottomBg.setAttribute("color", "#000000");
          bottomBg.setAttribute("opacity", "0.88");
          bottomPanel.appendChild(bottomBg);

          const descText = document.createElement("a-text");
          descText.setAttribute("color", "#dddddd");
          descText.setAttribute("align", "center");
          descText.setAttribute("width", "2.3");
          descText.setAttribute("position", "0 0 0.02");
          descText.setAttribute("wrap-count", "44");
          descText.setAttribute("value", desc);
          bottomPanel.appendChild(descText);

          textBlock.appendChild(bottomPanel);
        }

        marker.appendChild(textBlock);

        scene.appendChild(marker);
        markers.push(marker);
      });

      attachMarkerEvents();
      scheduleFallback();
    }

    async function uploadImageFromBlob(blob) {
      const fileName = crypto.randomUUID() + ".jpg";
      const path = "submissions/" + fileName;

      const { data, error } = await supabaseClient.storage
        .from("submissions")
        .upload(path, blob, {
          cacheControl: "3600",
          upsert: false
        });

      if (error) {
        throw error;
      }
      return data.path;
    }

    function getCurrentLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          return resolve({ lat: null, lon: null });
        }
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            resolve({
              lat: pos.coords.latitude,
              lon: pos.coords.longitude
            });
          },
          (err) => {
            console.warn("GPS error:", err);
            resolve({ lat: null, lon: null });
          },
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    async function createDraftSubmissionFromImageDataUrl(dataUrl) {
      statusEl.textContent = "Spremam draft (slika + lokacija)...";

      const res = await fetch(dataUrl);
      const blob = await res.blob();

      const imagePath = await uploadImageFromBlob(blob);

      const loc = await getCurrentLocation();
      const latitude = loc.lat;
      const longitude = loc.lon;

      const user = await ensureAnonAuth();
      const ownerId = user?.id || null;
      const submitter = await ensureNickname();
      if (!submitter) {
        throw new Error("Nije postavljeno korisniƒçko ime.");
      }

      const { data, error } = await supabaseClient
        .from("artwork_submissions")
        .insert({
          artist_name: null,
          title: null,
          type: null,
          description: null,
          latitude,
          longitude,
          submitted_by: submitter,
          owner_id: ownerId,
          image_path: imagePath,
          status: "draft"
        })
        .select("id")
        .single();

      if (error) {
        console.error(error);
        throw error;
      }

      return data.id;
    }

    newSubmitBtn.addEventListener("click", () => {
      captureInput.value = "";
      captureInput.click();
    });

    captureInput.addEventListener("change", async () => {
      const file = captureInput.files && captureInput.files[0];
      if (!file) {
        statusEl.textContent = "Slikanje je otkazano. Poku≈°aj ponovno.";
        return;
      }

      statusEl.textContent = "Obraƒëujem sliku...";

      const reader = new FileReader();
      reader.onload = async () => {
        const dataUrl = reader.result;
        if (!dataUrl) {
          statusEl.textContent = "Dogodila se gre≈°ka pri ƒçitanju slike.";
          return;
        }

        try {
          try {
            localStorage.setItem("street-ar-pending-image", dataUrl);
          } catch (e) {
            console.error(e);
          }

          const draftId = await createDraftSubmissionFromImageDataUrl(dataUrl);
          lastDraftId = draftId;

          statusEl.textContent = "Draft spremljen. Odaberi ≈°to ≈æeli≈° dalje.";
          if (noMarkerActions) noMarkerActions.style.display = "none";
          postCapturePanel.style.display = "block";
        } catch (e) {
          console.error(e);
          statusEl.textContent =
            "Gre≈°ka pri spremanju drafta: " + (e.message || e.toString());
        }
      };
      reader.onerror = () => {
        statusEl.textContent = "Dogodila se gre≈°ka pri ƒçitanju slike.";
      };
      reader.readAsDataURL(file);
    });

    btnEditNow.addEventListener("click", () => {
      if (!lastDraftId) {
        window.location.href = "submit.html";
        return;
      }
      window.location.href =
        "submit.html?id=" +
        encodeURIComponent(lastDraftId) +
        "&mode=edit-draft";
    });

    btnSaveDraftOnly.addEventListener("click", () => {
      postCapturePanel.style.display = "none";
      statusEl.textContent =
        "Draft je spremljen. Mo≈æe≈° ga kasnije dovr≈°iti u svojim unosima.";
    });

    btnOpenDetail.addEventListener("click", () => {
      if (!currentArtworkId) return;
      window.location.href =
        "detail.html?id=" + encodeURIComponent(currentArtworkId);
    });

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await ensureAnonAuth();
      } catch (e) {
        console.error("ensureAnonAuth error", e);
      }

      scheduleFallback();
      loadMarkersFromSupabase();

      fetch("navbar.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("navbar-placeholder").innerHTML = html;
          const current = "scan";
          document
            .querySelectorAll("#navbar .nav-item")
            .forEach((item) => {
              if (item.dataset.tab === current) item.classList.add("active");
            });
        });
    });
  </script>
</body>
</html>
