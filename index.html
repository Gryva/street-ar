<!DOCTYPE html>
<html lang="hr">
  <head>
    <meta charset="UTF-8" />
    <title>Street AR ‚Äì Dobrodo≈°li</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Supabase + auth helper -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>

    <!-- Roboto Condensed -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;600;700&display=swap&subset=latin-ext"
    />

    <style>
      body {
        font-family: "Roboto Condensed", system-ui, -apple-system, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #15181f, #000 70%);
        color: #fff;
        min-height: 100vh;
        padding-bottom: 80px; /* prostor za navbar */
      }

      .brand-title {
        font-size: 28px;
        letter-spacing: 0.16em;
        text-transform: uppercase;
      }

      .brand-subtitle {
        font-size: 13px;
        opacity: 0.8;
      }

      .card-welcome {
        background: linear-gradient(
          145deg,
          #050505 0%,
          #111111 45%,
          #15181f 100%
        );
        border-radius: 16px;
        border: 1px solid #222;
        box-shadow: 0 0 22px rgba(0, 0, 0, 0.8);
      }

      .form-label {
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #bbbbbb;
      }

      .form-control {
        border-radius: 999px;
        background: #050505;
        border: 1px solid #333;
        color: #fff;
        font-size: 14px;
      }

      .form-control:focus {
        background: #080808;
        border-color: #ffd700;
        box-shadow: 0 0 0 0.15rem rgba(255, 215, 0, 0.35);
        color: #fff;
      }

      .btn-primary {
        border-radius: 999px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 13px;
        padding-block: 10px;
        background: radial-gradient(
          circle at top left,
          rgba(255, 215, 0, 0.25),
          rgba(0, 0, 0, 0.98)
        );
        border-color: rgba(255, 215, 0, 0.8);
      }

      .btn-primary:hover {
        background: radial-gradient(
          circle at top left,
          rgba(255, 215, 0, 0.4),
          rgba(0, 0, 0, 0.98)
        );
        border-color: rgba(255, 215, 0, 1);
      }

      .hint {
        font-size: 11px;
        opacity: 0.78;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        opacity: 0.9;
      }

      .pill span {
        font-size: 14px;
      }

      #navbar-placeholder {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 50;
      }
    </style>
  </head>
  <body class="bg-dark text-light">
    <main class="container py-4">
      <div class="d-flex flex-column align-items-start mb-4">
        <div class="pill mb-2">
          <span>üëã</span> dobrodo≈°li u Street AR
        </div>
        <h1 class="brand-title mb-1">Street AR</h1>
        <div class="brand-subtitle">
          web aplikacija za unos i otkrivanje uliƒçnih vizuala
        </div>
      </div>

      <div class="card card-welcome p-4">
        <h2 class="h5 mb-3">Tvoj potpis u galeriji</h2>
        <p class="mb-3" style="font-size: 13px; opacity: 0.85;">
          Prije nego krene≈° skenirati ili dodavati radove, upi≈°i nadimak ili ime
          pod kojim ≈æeli≈° biti potpisan uz svoje unose. To ime ƒáemo koristiti
          za sve buduƒáe prijave.
        </p>

        <form id="welcome-form" class="mt-2">
          <div class="mb-3">
            <label for="username" class="form-label">Tvoje korisniƒçko ime</label>
            <input
              type="text"
              id="username"
              class="form-control"
              placeholder="npr. lunar_123"
              autocomplete="off"
              required
            />
            <div class="hint mt-1">
              Koristi nadimak ili ime koje ≈æeli≈° da se pojavljuje uz radove.
              Mo≈æe≈° ga kasnije promijeniti u postavkama preglednika (localStorage).
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-2">
            Spremi i nastavi u aplikaciju
          </button>
        </form>
      </div>
    </main>

    <div id="navbar-placeholder"></div>

    <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const form = document.getElementById("welcome-form");
    const input = document.getElementById("username");

    // 1) osiguraj anon auth
    const user = await ensureAnonAuth();
    console.log("Anon user:", user?.id);

    // 2) ako veƒá ima nickname (localStorage ili submitter_profiles),
    // preskoƒçi ekran i idi na aplikaciju
    const existing = await ensureNickname();
    if (existing) {
      input.value = existing;
      window.location.href = "scan.html";
      return;
    }

    // 3) ako nema profila -> koristimo formu za prvi odabir nadimka
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const candidate = input.value.trim();
      if (!candidate) {
        input.focus();
        return;
      }

      // provjera: koristi li taj nadimak NETKO DRUGI
      const { data: taken, error } = await supabaseClient
        .from("submitter_profiles")
        .select("owner_id")
        .eq("nickname", candidate)
        .maybeSingle();

      if (error) {
        console.error("check nickname error", error);
        alert("Dogodila se gre≈°ka pri provjeri imena. Poku≈°aj ponovo.");
        return;
      }

      // ako nadimak postoji za nekog drugog usera -> blokiraj
      if (taken && taken.owner_id !== user.id) {
        alert("To korisniƒçko ime veƒá koristi netko drugi. Odaberi drugo.");
        return;
      }

      // ako veƒá postoji red s ovim owner_id i ovim nicknameom,
      // ne radimo novi insert ‚Äì samo ga prihvatimo
      if (!taken) {
        const { error: insertError } = await supabaseClient
          .from("submitter_profiles")
          .insert({
            owner_id: user.id,
            nickname: candidate
          });

        if (insertError) {
          console.error("insert nickname error", insertError);
          alert("Ne mogu spremiti korisniƒçko ime. Poku≈°aj ponovo.");
          return;
        }
      }

      setStoredUsername(candidate);
      window.location.href = "scan.html";
    });

    // Navbar
    fetch("navbar.html")
      .then((res) => res.text())
      .then((html) => {
        document.getElementById("navbar-placeholder").innerHTML = html;
        // ovdje i dalje ne moramo imati aktivan tab
      });
  });
</script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
